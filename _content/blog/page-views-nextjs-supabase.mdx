---
title: 'Realtime Page Views with Next.js and Supabase'
brief: 'Lets Build our own real-time page view tracker using Next.js as the frontend framework and Supabase as the datastore.'
date: '2020-12-16'
---

One of the best ways to understand how your blog posts are doing are page views. You can begin to understand what posts and information your readers care more about based on number of views. You can then focus your efforts on the more important content.

Many people use tools like [Google](https://analytics.google.com/) or [Fathom](https://usefathom.com/ref/45XEAJ) Analytics for tracking traffic. With the rise of Ad-Blockers, your traffic collected with these services are not nessarily accurate.

Why not build your own page view tracker using your own API routes. The beauty of using your own API routes, ad-blockers will not risk blocking the request without possibly breaking website functionality. This will allow for a more accurate count of page views.

## Tools Used

### Next.js

We will be using [Next.js](https://nextjs.org/) as our frontend framework. It gives us the power of prerendered React.js, serverless api routes, and typescript with minimal configuration.

### Supabase

[Supabase](https://supabase.io/) is an open-source alternative to firebase. They offer an API wrapped Postgres Database with real-time subscriptions.

## Getting Started

Sign in or Sign up for Supabase. Then create a new project. You can either use an existing organization (if you have one) or create a new one.

Enter your project name, add a **strong** password for your database, and select which region you want your database.

Once the database finishes setting up, we need to create a table to store our pages and the total view count. Navigate to the SQL editor and switch to the `Query-1` tab.
You can then paste the bellow SQL query and run it to create a new table called `pages` with columns `id`, `slug`, `view_count`, and `updated_at`.

```sql
CREATE TABLE pages (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  slug text UNIQUE NOT NULL,
  view_count bigint DEFAULT 1 NOT NULL,
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);
```

We need to run one more query to add a stored procedure to our database. A stored procedure allows us to add or extend functionality to the database.

Lets first breakdown the query bellow.

```sql
CREATE OR REPLACE FUNCTION increment_page_view(page_slug TEXT)
RETURNS void
LANGUAGE plpgsql
AS $$
BEGIN
    IF EXISTS (SELECT FROM pages WHERE slug=page_slug) THEN
        UPDATE pages
        SET view_count = view_count + 1,
            updated_at = now()
        WHERE slug = page_slug;
    ELSE
        INSERT into pages(slug) VALUES (page_slug);
    END IF;
END;
$$;
```

1. This adds a function called `increment_page_view` that has a parameter of `page_slug`.
2. It sets the language to `plpgsql` which is specific to postgres.
3. When you trigger the function, it checks to see if a row exists where `slug` equals the parameter `page_slug`.
4. If it exists, update the row by adding `1` to `view_count` and setting `updated_at` with `now()`.
5. If it does not exist, insert a new row with `slug` equal to `page_slug`.

Now that we know what this function actually does, open a new query tab in the SQL editor. Paste the query in and run it.

Your database should be fully set up to track page views now!

The final thing we need to do is get your API keys located in **API** under **settings**.

Now add them to your next.js project's `.env` file.

```bash
SUPABASE_SERVICE_KEY=
NEXT_PUBLIC_SUPABASE_CLIENT_KEY=
NEXT_PUBLIC_SUPABASE_URL=
```
